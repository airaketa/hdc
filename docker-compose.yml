version: '3'
services:
    openhab:
        image: openhab/openhab:2.5.1
        restart: always
        #network_mode: host
        volumes:
            - /etc/localtime:/etc/localtime:ro
            - /etc/timezone:/etc/timezone:ro
            - ./config/openhab/addons:/openhab/addons
            - ./data/openhab/openhab_conf:/openhab/conf
            - ./data/openhab/userdata:/openhab/userdata
        environment:
            #OPENHAB_HTTP_PORT: 8080
            #OPENHAB_HTTPS_PORT: 8443
            EXTRA_JAVA_OPTS: -Duser.timezone=Europe/Moscow
    postgres:
        image: postgres:9.6.16
        restart: always
        volumes:
            - /mnt/raid1/postgres:/var/lib/postgresql/data
        env_file:
            - ./db.env
        networks:
            - backend
    nextcloud:
        image: nextcloud:18.0.0-apache
        container_name: nextcloud
        restart: always
        volumes:
            - /mnt/raid1/nextcloud:/var/www/html
        links:
            - postgres
        environment:
            POSTGRES_HOST: postgres
        env_file:
            - ./db.env
        networks:
            - backend
            - traefik
        labels:
            - traefik.enable=true
            - traefik.http.routers.nextcloud.rule=Host(`${HOST}`)
            - traefik.http.routers.nextcloud.entrypoints=web
            - traefik.http.middlewares.nextcloud.stripprefix.forceslash=false
    traefik:
        image: arm64v8/traefik:2.2
        restart: always
        command:
            - --api.insecure=true
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --entrypoints.web.address=:80
        ports:
            - 80:80
            - 443:443
            - 8080:8080
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks:
            - traefik
networks:
    backend:
    traefik:
